<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="resize-listener.html">

<polymer-element name="chapter-view" attributes="mangaId mangaTitle chapterId chapterNumber chapterTitle">
  <template>
		<style>
		 .page img {
		   margin: 0 auto;
		   display: block;
		 }

		 .page {
		   width: 100%;
		 }

		 core-toolbar {
		   background-color: #4CAF50;
		   color: #FFF;
		 }
    </style>
		
		<core-ajax
			 id="ajax"
			 handleAs="json"
			 on-core-response="{{handleResponse}}"></core-ajax>
		<core-header-panel fit>
			<core-toolbar>
        <paper-icon-button icon="arrow-back" on-click="{{backClicked}}"></paper-icon-button>
				<div>Chapter {{chapterNumber}}: {{chapterTitle}}</div>
			</core-toolbar>

			<core-list
				 id="list"
				 fit
				 style="min-height:10px"
				 height="{{medianImageHeight * ((listWidth > medianImageWidth ? medianImageWidth : listWidth) / medianImageWidth)}}">
				<template>
					<div class="page" >
						<img src="https://cdn.mangaeden.com/mangasimg/{{model[1]}}"
								 width="{{listWidth > model[2] ? model[2] : listWidth}}"
								 height="{{model[3] * ((listWidth > model[2] ? model[2] : listWidth) / model[2])}}">
					</div>
				</template>
			</core-list>
		</core-header-panel>
  </template>
	<script>
    Polymer({
		//  width="{{model[2]}}" height="{{model[3]}}"
		  ready: function() {
		    if (this.chapterId) {
		      this.chapterIdChanged("", this.chapterId);
		    }

		    this.medianImageWidth = 256; // Some "reasonable" default.
		    this.medianImageHeight = 1024; // Some "reasonable" default.
		    this.listWidth = 360; // Some "reasonable" default.
		  },
		  domReady: function() {
		    this.listWidth = Math.max(360, this.$.list.clientWidth);

		    var self = this;
		    window.addResizeListener(this.$.list, function() {
		        self.listWidth = Math.max(1, self.$.list.clientWidth);
		      });
		  },
		  chapterIdChanged: function (oldValue, newValue) {
		    console.log(newValue);
		    this.$.list.data = [];
		    this.$.ajax.url = "https://cors-anywhere.herokuapp.com/www.mangaeden.com/api/chapter/" + newValue + "/";
		    this.$.ajax.go();
  		},
		  ascendingImageData: function (a, b) {
		    return a[0] - b[0];
		  },
		  ascendingImageWidth: function (a, b) {
		    return a[2] - b[2];
		  },
		  ascendingImageHeight: function (a, b) {
		    return a[3] - b[3];
		  },
		  handleResponse: function (event, detail, sender) {
		    var images = detail.response.images;

		    if (!images || images.length == 0) {
		      this.$.list.data = [];
		      return;
		    }

        images.sort(this.ascendingImageWidth);
        this.medianImageWidth = Math.max(256, images[Math.floor(images.length/2)][2]);
		    console.log("Median width updated to " + this.medianImageWidth);

        images.sort(this.ascendingImageHeight);
        this.medianImageHeight = Math.max(1024, images[Math.floor(images.length/2)][3]);
		    console.log("Median height updated to " + this.medianImageHeight);

		    images.sort(this.ascendingImageData);

		    this.$.list.data = images;
		    this.$.list.scrollToItem(0);
		    // TODO: Adjust list.height to be the average height of the new data.
		  },
		  backClicked: function () {
		    this.$.list.data = [];
		    document.querySelector("app-router").go(
		      "/" + escape(this.mangaId) + "/" + escape(this.mangaTitle));
		    this.fire("back", {});
		  },
		  dateFromEpoch: function (seconds) {
		    return (new Date(seconds * 1000)).toLocaleDateString();
		  }
    });
	</script>
</polymer-element>
