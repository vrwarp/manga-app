<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<polymer-element name="chapter-view" attributes="chapterId chapterNumber chapterTitle">
  <template>
		<style>
     .row {
			 margin: 0;
			 padding: 10px;
			 border: 1px solid red;
     }
    </style>
		
		<core-ajax
			 id="ajax"
			 handleAs="json"
			 on-core-response="{{handleResponse}}"></core-ajax>
		<core-header-panel fit>
			<core-toolbar>
        <paper-icon-button icon="arrow-back" on-click="{{backClicked}}"></paper-icon-button>
				<div>Chapter {{chapterNumber}}: {{chapterTitle}}</div>
			</core-toolbar>

			<core-list
				 id="list"
				 fit
				 style="min-height:10px"
				 height="1000">
				<template>
					<div horizontal center-justified layout>
						<img src="https://cdn.mangaeden.com/mangasimg/{{model[1]}}" width="{{model[2]}}" height="{{model[3]}}">
					</div>
				</template>
			</core-list>
		</core-header-panel>
  </template>
	<script>
    Polymer({
		  chapterIdChanged: function (oldValue, newValue) {
		    console.log(newValue);
		    this.$.list.data = [];
		    this.$.ajax.url = "https://cors-anywhere.herokuapp.com/www.mangaeden.com/api/chapter/" + newValue + "/";
		    this.$.ajax.go();
  		},
		  ascendingImageData: function (a, b) {
		    return a[0] - b[0];
		  },
		  handleResponse: function (event, detail, sender) {
		    var images = detail.response.images;
		    images.sort(this.ascendingImageData);
		    this.$.list.data = images;
		    this.$.list.scrollToItem(0);
		    // TODO: Adjust list.height to be the average height of the new data.
		  },
		  backClicked: function () {
		    this.$.list.data = [];
		    this.fire("back", {});
		  },
		  dateFromEpoch: function (seconds) {
		    return (new Date(seconds * 1000)).toLocaleDateString();
		  }
    });
	</script>
</polymer-element>
