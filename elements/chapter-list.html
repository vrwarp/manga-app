<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-shadow/paper-shadow.html">

<polymer-element name="chapter-list" attributes="mangaId mangaTitle">
  <template>
		<style>
     .card {
			 margin: 0;
			 padding: 20px;
		   width: 320px;
		   height: 180px;
		   border-radius: 2px;
     }

		 .card > paper-shadow {
		   padding: 10px;
		   width: 100%;
		   height: 100%;
		   background-color: #FFF;
		 }

		 .title {
		   font-size: 24px;
		 }

		 .chapterNumber {
		 }

		 .date {
		   text-align: right;
		 }

		 core-toolbar {
		   background-color: #4CAF50;
		   color: #FFF;
		 }

		 core-list {
		   background-color: #EEE;
		 }
    </style>
		
		<core-ajax
			 id="ajax"
			 handleAs="json"
			 response="{{chapterListResponse}}"></core-ajax>

		<core-header-panel mode="seamed" fit>
			<core-toolbar>
				<paper-icon-button icon="arrow-back" on-click="{{backClicked}}"></paper-icon-button>
				<div>{{mangaTitle}}</div>
			</core-toolbar>

			<core-list
				 fit
				 id="list"
				 style="min-height:10px"
				 width="320"
				 height="180"
				 grid
				 on-core-activate="{{selectChapter}}">
				<template>
					<div class="card">
						<paper-shadow z="2" vertical layout>
							<div class="title">{{model.title}}</div>
							<div class="chapterNumber">Chapter {{model.number}}</div>
							<div flex></div>
							<div class="date">{{dateFromEpoch(model.date)}}</div>
						</paper-shadow>
					</div>
				</template>
			</core-list>
		</core-header-panel>
  </template>
	<script>
		(function() {
		  var chapterList_ = [];
		  var mangaId_ = "some filler value";
      Polymer({
		    domReady: function() {
		      if (this.mangaId == mangaId_) {
		        this.$.list.data = chapterList_;
		      }
		    },
		    convertToExpectedModel: function (model) {
		      return {
		        id: model[3],
		        title: model[2],
		        number: model[0],
		        date: model[1]
		      };
		    },
		    mangaIdChanged: function (oldValue, newValue) {
		      if (mangaId_ == newValue) {
		        return;
		      }

		      console.log(newValue);

		      // Clear the chapterList_ if it isn't the same.
		      this.$.list.data = [];
		      chapterList_ = [];

		      this.$.ajax.url = "https://cors-anywhere.herokuapp.com/www.mangaeden.com/api/manga/" + newValue + "/";
		      this.$.ajax.go();
  		  },
		    chapterListResponseChanged: function (oldValue, newValue) {
		      chapterList_ = newValue.chapters.map(this.convertToExpectedModel);
		      mangaId_ = this.mangaId;
		      this.$.list.data = chapterList_;
  		  },
  		  selectChapter: function (event, detail, sender) {
		      console.log(detail);
		      document.querySelector("app-router").go(
		        "/" + [this.mangaId, this.mangaTitle, detail.data.id, detail.data.number, detail.data.title].map(escape).join("/"));
        },
		    backClicked: function () {
		      document.querySelector("app-router").go("/");
		    },
		    dateFromEpoch: function (seconds) {
		      return (new Date(seconds * 1000)).toLocaleDateString(undefined, {year: "2-digit", month: "2-digit", day: "2-digit"});
		    }
      });
		})();
	</script>
</polymer-element>
