<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<polymer-element name="chapter-list" attributes="mangaId mangaTitle">
  <template>
		<style>
     .row {
			 margin: 0;
			 padding: 10px;
			 border: 1px solid red;
		   width: 100%;
     }
    </style>
		
		<core-ajax
			 id="ajax"
			 handleAs="json"
			 response="{{chapterListResponse}}"></core-ajax>

		<core-header-panel mode="seamed" fit>
			<core-toolbar>
				<paper-icon-button icon="arrow-back" on-click="{{backClicked}}"></paper-icon-button>
				<div>{{mangaTitle}}</div>
			</core-toolbar>

			<core-list
				 fit
				 id="list"
				 style="min-height:10px"
				 data="{{chapterList}}"
				 height="50"
				 on-core-activate="{{selectChapter}}">
				<template>
					<div class="row" horizontal layout>
						<div>Chapter {{model[0]}}: {{model[2]}}</div>
						<div flex></div>
						<div>{{dateFromEpoch(model[1])}}</div>
					</div>
				</template>
			</core-list>
		</core-header-panel>
  </template>
	<script>
		(function() {
		  var chapterList_ = [];
      Polymer({
		    ready: function() {
		      if (this.mangaId) {
		        this.mangaIdChanged(this.mangaId, this.mangaId);
		      }
		    },
		    mangaIdChanged: function (oldValue, newValue) {
		      console.log(newValue);

		      // Clear the chapterList_ if it isn't the same.
		      if (oldValue != newValue) {
		        chapterList_.splice(0, chapterList_.length);
		      }

		      this.$.ajax.url = "https://cors-anywhere.herokuapp.com/www.mangaeden.com/api/manga/" + newValue + "/";
		      this.$.ajax.go();
  		  },
		    chapterListResponseChanged: function (oldValue, newValue) {
		      chapterList_.splice.apply(
		        chapterList_, [0, chapterList_.length].concat(newValue.chapters));
  		  },
		    get chapterList() {
		      return chapterList_;
		    },
  		  selectChapter: function (event, detail, sender) {
		      console.log(detail);
		      var chapterId = detail.data[3];
		      var chapterNumber = detail.data[0];
		      var chapterTitle = detail.data[2];
		      document.querySelector("app-router").go(
		        "/" + [this.mangaId, this.mangaTitle, chapterId, chapterNumber, chapterTitle].map(escape).join("/"));
        },
		    backClicked: function () {
		      document.querySelector("app-router").go("/");
		    },
		    dateFromEpoch: function (seconds) {
		      return (new Date(seconds * 1000)).toLocaleDateString();
		    }
      });
		})();
	</script>
</polymer-element>
